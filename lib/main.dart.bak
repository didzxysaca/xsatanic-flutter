import 'package:flutter/material.dart';
import 'package:flutter/services.dart'; 
import 'package:flutter_inappwebview/flutter_inappwebview.dart';
import 'package:url_launcher/url_launcher.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Fullscreen immersive + force portrait
  SystemChrome.setEnabledSystemUIMode(SystemUiMode.immersiveSticky);
  SystemChrome.setPreferredOrientations([
    DeviceOrientation.portraitUp,
  ]);
  SystemChrome.setSystemUIOverlayStyle(
    const SystemUiOverlayStyle(statusBarColor: Colors.transparent),
  );

  runApp(const XSatanicApp());
}

class XSatanicApp extends StatelessWidget {
  const XSatanicApp({super.key});

  @override
  Widget build(BuildContext context) {
    return const MaterialApp(
      debugShowCheckedModeBanner: false,
      home: WebContainer(),
    );
  }
}

class WebContainer extends StatefulWidget {
  const WebContainer({super.key});

  @override
  State<WebContainer> createState() => _WebContainerState();
}

class _WebContainerState extends State<WebContainer>
    with WidgetsBindingObserver {
  InAppWebViewController? _controller;
  late PullToRefreshController _pullToRefreshController;

  // Jembatan komunikasi ke Android
  static const _serviceChannel = MethodChannel('xsatanic/service');

  String buildUrl() {
    return "https"
        "://"
        "xsat"
        "anic"
        ".dxy"
        "vxz"
        ".my"
        ".id";
  }

  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addObserver(this);

    // Memanggil service saat aplikasi dijalankan
    try {
      _serviceChannel.invokeMethod('startService');
    } catch (e) {
      debugPrint("Gagal menjalankan service: $e");
    }

    // ===== PULL TO REFRESH (VERSI FORCE ENABLE) =====
    _pullToRefreshController = PullToRefreshController(
      settings: PullToRefreshSettings(
        color: Colors.red,
      ),
      onRefresh: () async {
        // Force scroll ke atas lalu reload tanpa menghapus session
        await _controller?.evaluateJavascript(
          source: """
            if (document.scrollingElement) {
              document.scrollingElement.scrollTop = 0;
            }
            window.location.reload(false);
          """,
        );
      },
    );
  }

  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    super.dispose();
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.resumed) {
      _controller?.evaluateJavascript(
        source: "console.log('resume: no auto refresh');",
      );
    }
  }

  Future<bool> _onWillPop() async {
    if (_controller != null && await _controller!.canGoBack()) {
      _controller!.goBack();
      return false;
    }
    return true;
  }

  void _injectAntiCopy(InAppWebViewController controller) {
    controller.evaluateJavascript(source: """
      (function () {
        const style = document.createElement('style');
        style.innerHTML = `
          * {
            -webkit-user-select: none !important;
            user-select: none !important;
          }
          input, textarea {
            -webkit-user-select: text !important;
            user-select: text !important;
          }
        `;
        document.head.appendChild(style);
      })();
    """);
  }

  @override
  Widget build(BuildContext context) {
    // ignore: deprecated_member_use
    return WillPopScope(
      onWillPop: _onWillPop,
      child: Scaffold(
        backgroundColor: Colors.black,
        body: InAppWebView(
          pullToRefreshController: _pullToRefreshController,

          initialUrlRequest: URLRequest(
            url: WebUri(buildUrl()),
            headers: {
              "Cache-Control": "max-age=86400",
            },
          ),

          initialSettings: InAppWebViewSettings(
            javaScriptEnabled: true,
            domStorageEnabled: true,
            databaseEnabled: true,
            cacheEnabled: true,
            clearCache: false,
            clearSessionCache: false,
            cacheMode: CacheMode.LOAD_CACHE_ELSE_NETWORK,
            thirdPartyCookiesEnabled: true,
            sharedCookiesEnabled: true,
            allowsInlineMediaPlayback: true,
            mediaPlaybackRequiresUserGesture: false,
            supportZoom: false,
            transparentBackground: true,
            horizontalScrollBarEnabled: false,
            verticalScrollBarEnabled: false,
            disableContextMenu: true,
            useShouldOverrideUrlLoading: true,
          ),

          onWebViewCreated: (controller) {
            _controller = controller;
          },

          onLoadStop: (controller, url) async {
            _pullToRefreshController.endRefreshing();
            _injectAntiCopy(controller);
          },

          onLoadError: (controller, url, code, message) {
            _pullToRefreshController.endRefreshing();
          },

          shouldOverrideUrlLoading: (controller, action) async {
            final uri = action.request.url!;
            const internalDomain = "xsatanic.dxyvxz.my.id";

            if (!uri.host.contains(internalDomain)) {
              if (await canLaunchUrl(uri)) {
                await launchUrl(
                  uri,
                  mode: LaunchMode.externalApplication,
                );
                return NavigationActionPolicy.CANCEL;
              }
            }
            return NavigationActionPolicy.ALLOW;
          },

          onDownloadStartRequest: (controller, request) async {
            final uri = request.url;
            if (await canLaunchUrl(uri)) {
              await launchUrl(
                uri,
                mode: LaunchMode.externalApplication,
              );
            }
          },

          androidOnPermissionRequest:
              (controller, origin, resources) async {
            return PermissionRequestResponse(
              resources: resources,
              action: PermissionRequestResponseAction.GRANT,
            );
          },
        ),
      ),
    );
  }
}